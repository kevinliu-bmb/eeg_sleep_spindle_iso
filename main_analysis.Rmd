---
title: "EEG Spindle Analysis"
author: "Kevin Liu"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(broom)
library(effsize)
```

```{r initial_cleanup, message=FALSE}
subject_data = read_csv("data/eeg_metadata.csv") %>% 
  mutate(SID = sub("-.*$", "", SID)) %>% 
  select(SID, sex, age_year)

spindle_data = read_csv("data/features_spindles.csv") %>% 
  mutate(SID = sub("^(.*?)_.*$", "\\1", SID),
         SID = sub("-.*$", "", SID)) %>% 
  merge(subject_data, by = "SID", all.x = TRUE) %>% 
  select(SID, Group, sex, age_year, everything()) %>% 
  mutate(group = ifelse(Group == "TD", "HC", "ASD"),
         sex = ifelse(sex == 1, "M", "F")) %>% 
  select(SID, group, sex, everything(), -Group) %>% 
  column_to_rownames("SID")

spindle_data_usable = spindle_data %>% 
  select(everything(), -group, -sex, -age_year) %>% 
  filter(if_any(everything(), ~ !is.na(.)))

spindle_data_matched = spindle_data %>% 
  rownames_to_column("SID") %>% 
  # Filter out subjects with missing group and/or sex, age data
  filter(SID %in% rownames(spindle_data_usable),
         !is.na(sex)) %>% 
  column_to_rownames("SID")
```

```{r handle_missing_data}
gt10p_missing = spindle_data_matched %>%
  summarize(across(everything(), ~mean(is.na(.)) * 100)) %>%
  pivot_longer(everything(), names_to = "Feature", values_to = "Percent_Missing") %>%
  arrange(desc(Percent_Missing)) %>% 
  filter(Percent_Missing > 10) %>% 
  pull(Feature)

spindle_data_filt_imp = spindle_data_matched %>%
  # Remove features with more than 10% missing data
  select(-all_of(gt10p_missing)) %>% 
  # Impute missing values with median
  mutate(across(where(is.numeric), ~ ifelse(is.na(.), median(., na.rm = TRUE), .)),
         group = factor(group, levels = c("HC", "ASD")),
         sex = factor(sex, levels = c("F", "M")))

spindle_data_filt_imp %>% 
  rownames_to_column("SID") %>%
  select(SID, group, everything(), -sex, -age_year) %>% 
  write.csv("data/spindle_data_filtered_imputed.csv", row.names = FALSE)

spindle_data_filt_imp %>% 
  select(group, sex) %>% 
  table()
```

```{r t_statistics}
# Perform t-test for each feature by group and adjust p-values, keeping only significant results (p < 0.05)
signif_features = spindle_data_filt_imp %>%
  select(-sex) %>% 
  pivot_longer(cols = -group, names_to = "feature", values_to = "value") %>%
  group_by(feature) %>%
  nest() %>%
  mutate(
    test = map(data, ~ t.test(value ~ group, data = .x)),
    tidied = map(test, tidy)
  ) %>%
  unnest(tidied) %>%
  select(feature, estimate1, estimate2, statistic, p.value) %>%
  rename(
    mean_HC = estimate1,
    mean_ASD = estimate2,
    t_stat = statistic,
    p_value = p.value
  ) %>%
  mutate(p_adj = p.adjust(p_value, method = "bonferroni")) %>%
  arrange(p_adj) %>%
  filter(p_adj < 0.05)

signif_features
```

```{r effect_sizes}
cohens_d_results = spindle_data_filt_imp %>% 
  mutate(group = factor(group, levels = c("HC", "ASD")),
         sex = factor(sex, levels = c("F", "M"))) %>% 
  pivot_longer(-c(sex, group), names_to = "feature", values_to = "value") %>%
  group_by(feature) %>%
  summarise(cohens_d = cohen.d(value ~ group)$estimate) %>%
  arrange(desc(abs(cohens_d)))

signif_features_cohensd = signif_features %>%
  left_join(cohens_d_results, by = "feature") %>%
  arrange(desc(abs(cohens_d)))

final_ranking = signif_features_cohensd %>%
  mutate(category = case_when(
    str_detect(feature, "AMP")        ~ "Amplitude",
    str_detect(feature, "DENS")       ~ "Density",
    str_detect(feature, "DUR")        ~ "Duration",
    str_detect(feature, "CHIRP")      ~ "Chirp",
    str_detect(feature, "COUPL")      ~ "Coupling",
    str_detect(feature, "ISA_M")      ~ "ISA per Minute",
    str_detect(feature, "ISA_S")      ~ "ISA per Spindle",
    str_detect(feature, "ISA_T")      ~ "Total ISA",
    str_detect(feature, "NOSC")       ~ "Oscillations per Spindle",
    str_detect(feature, "DISPERSION") ~ "Dispersion Index",
    str_detect(feature, "FFT")        ~ "Spindle Frequency (FFT)",
    str_detect(feature, "SYMM2")      ~ "Folded-Symmetry Metric",
    str_detect(feature, "SYMM")       ~ "Symmetry Metric",
    str_detect(feature, "MINS")       ~ "Analysis Duration (minutes)",
    str_detect(feature, "NE")         ~ "Number of Epochs",
    TRUE                              ~ "Other"
  )) %>%
  arrange(p_adj, desc(abs(cohens_d)))

head(final_ranking, 10) %>% 
  write.csv("data/top10_significant_results.csv", row.names = FALSE)

head(final_ranking, 10)$feature
```

```{python mne}
import pandas as pd
import numpy as np
import mne
import matplotlib.pyplot as plt

# Load data
df = pd.read_csv("data/spindle_data_filtered_imputed.csv")

# Define EEG channels
channels = ['Fp1', 'Fp2', 'F3', 'F4', 'C3', 'C4', 'P3', 'P4',
            'O1', 'O2', 'F7', 'F8', 'T7', 'T8', 'P7', 'P8', 'Fz', 'Pz', 'Oz']

# Set up montage
montage = mne.channels.make_standard_montage('standard_1020')
info = mne.create_info(channels, sfreq=100, ch_types='eeg')
info.set_montage(montage)

# List of top 10 important features you provided
top_features = [
    "SP_CHIRP_all_P7",
    "SP_COUPL_MAG_slow_P7",
    "SP_DUR_slow_Fp2",
    "SO_TRANS_F3",
    "SO_NEG_DUR_F3",
    "SO_POS_DUR_T7",
    "SO_DUR_F3",
    "SO_TRANS_C3",
    "SP_COUPL_MAG_all_P8",
    "SP_ISA_M_slow_F4"
]

# Prepare subplots
fig, axes = plt.subplots(2, 5, figsize=(20, 10))
axes = axes.flatten()

# Plotting loop
for ax, feature in zip(axes, top_features):
    channel = feature.split('_')[-1]
    if channel not in channels:
        ax.axis('off')
        continue

    mean_ASD = df.loc[df['group']=='ASD', feature].mean()
    mean_HC = df.loc[df['group']=='HC', feature].mean()
    diff = mean_ASD - mean_HC

    diff_array = np.zeros(len(channels))
    diff_array[channels.index(channel)] = diff

    # Clearer plotting with better formatting
    im, _ = mne.viz.plot_topomap(
        diff_array, info, axes=ax, show=False, cmap='RdBu_r', contours=6,
        extrapolate='local', vlim=(np.min(diff_array), np.max(diff_array))
    )

    ax.set_title(f"{feature}", fontsize=12, pad=10)

# Adjust layout to avoid overlapping
fig.subplots_adjust(top=0.9, bottom=0.1, left=0.05, right=0.95, hspace=0.3, wspace=0.2)

# Add single clear colorbar
cbar_ax = fig.add_axes([0.96, 0.15, 0.015, 0.7])
fig.colorbar(im, cax=cbar_ax, label='Difference (ASD - HC)')

# Main title
fig.suptitle('Spatial Distributions (ASD - HC)', fontsize=15)

plt.show()
```


